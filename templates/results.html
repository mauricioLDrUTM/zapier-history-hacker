{% extends "base.html" %}
{% block title %}Analysis Results - JSON Event Analyzer{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary mb-3">
        <i class="fas fa-chart-bar me-3"></i>Data Analysis Dashboard
      </h1>
      <p class="lead text-muted">Interactive analysis for <strong>{{ results.filename }}</strong></p>
    </div>

    <!-- File Summary -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="card-title mb-0">
              <i class="fas fa-database me-2"></i>Dataset Overview
            </h5>
            <p class="text-muted mb-0">
              <strong>{{ results.total_events }}</strong> events loaded and ready for analysis
            </p>
          </div>
          <div class="col-md-4 text-end">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
              <i class="fas fa-file-code fa-2x text-primary"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Data Query Engine -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="card-title mb-0">
          <i class="fas fa-search me-2"></i>Interactive Query Engine
        </h4>
        <p class="mb-0 opacity-75">Analyze your data using natural language queries</p>
      </div>
      <div class="card-body">
        
        <!-- Query Input -->
        <div class="row mb-3">
          <div class="col-md-8">
            <label class="form-label fw-bold">Query</label>
            <textarea id="dslInput" class="form-control" rows="2"
              placeholder="where event_name == 'Schedule' and isfire == 'yes' | select *"></textarea>
          </div>
          <div class="col-md-4 d-flex flex-column">
            <label class="form-label fw-bold">Actions</label>
            <div class="d-flex gap-2 flex-wrap">
              <button id="runQueryBtn" class="btn btn-primary flex-grow-1">
                <i class="fas fa-play me-1"></i>Run Query
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Examples -->
        <div class="mb-3">
          <label class="form-label fw-bold">Quick Examples</label>
          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="select *">
              üìã View All Data
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where event_name == 'Schedule' and isfire == 'yes' | select *">
              üéØ Schedule + Fired Events
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where event_name == 'Schedule' and isfire == 'yes' | count by status">
              üìä Count by Status
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where isfire == 'yes' | group by status">
              üìà Fired Events by Status
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where isfire == 'yes' | count by event_name | limit 10">
              üî• Top 10 Fired Events
            </button>
          </div>
        </div>

        <!-- Query Help -->
        <div class="alert alert-info">
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-lightbulb me-1"></i>Query Syntax Examples:</h6>
              <ul class="mb-0 small">
                <li><code>where event_name == "Schedule"</code> - Filter by event name</li>
                <li><code>where isfire == "yes"</code> - Filter by fired events</li>
                <li><code>where status == "success"</code> - Filter by status</li>
                <li><code>select *</code> - Show all columns</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6><i class="fas fa-chart-bar me-1"></i>Aggregation Examples:</h6>
              <ul class="mb-0 small">
                <li><code>count by status</code> - Count events by status</li>
                <li><code>group by event_name</code> - Group by event name</li>
                <li><code>limit 20</code> - Show only first 20 results</li>
                <li><code>offset 10</code> - Skip first 10 results</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Interactive Event Discovery -->
        <div class="card mb-3" id="eventDiscoveryCard" style="display:none;">
          <div class="card-header bg-info text-white">
            <h6 class="card-title mb-0">
              <i class="fas fa-lightbulb me-2"></i>Discovered Event Types
              <small class="opacity-75">Click to build queries</small>
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-fire me-1"></i>Event Names <span id="eventNameCount" class="badge bg-primary"></span></h6>
                <div id="eventNamesList" class="d-flex flex-wrap gap-1 mb-3"></div>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-toggle-on me-1"></i>Status Values <span id="statusCount" class="badge bg-success"></span></h6>
                <div id="statusList" class="d-flex flex-wrap gap-1 mb-3"></div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-check-circle me-1"></i>Fire Status <span id="fireStatusCount" class="badge bg-warning"></span></h6>
                <div id="fireStatusList" class="d-flex flex-wrap gap-1 mb-3"></div>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-calendar me-1"></i>Date Range</h6>
                <div id="dateRangeInfo" class="text-muted small"></div>
              </div>
            </div>
            
            <!-- DSL Builder -->
            <div class="mt-3 p-3 bg-light rounded">
              <h6><i class="fas fa-tools me-1"></i>Query Builder</h6>
              <div id="dslBuilder" class="mb-2">
                <span class="text-muted">Click on event types above to build your query...</span>
              </div>
              <div class="d-flex gap-2">
                <button id="clearBuilderBtn" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-eraser me-1"></i>Clear
                </button>
                <button id="useBuiltQueryBtn" class="btn btn-primary btn-sm">
                  <i class="fas fa-arrow-up me-1"></i>Use Query
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Query Results -->
        <div id="queryMeta" class="mt-3"></div>
        <div class="table-responsive mt-3" id="queryTableWrap" style="display:none;">
          <table class="table table-sm table-striped table-hover" id="queryTable"></table>
        </div>

        <pre id="catalogOut" class="bg-light p-2 rounded mt-3"
          style="max-height:250px; overflow:auto; display:none;"></pre>
      </div>
    </div>


    <div class="text-center mt-4">
      <a href="{{ url_for('index') }}" class="btn btn-primary me-2">
        <i class="fas fa-arrow-left me-2"></i>Analyze Another File
      </a>
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Print Results
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* DataTables custom styling */
  .dataTables_wrapper .dt-buttons {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .dataTables_filter {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .table thead th {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    white-space: nowrap;
  }
  .dataTables_wrapper .btn-group > .btn {
    margin: 0.25rem;
  }
  .dataTables_info {
    padding-top: 0.5rem !important;
  }
  .dataTables_paginate .pagination {
    margin: 0;
  }

  /* Event Discovery Styling */
  .event-chip {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    color: #0056b3;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  .event-chip:hover {
    background: #b3d9ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .event-chip.active {
    background: #0056b3;
    color: white;
  }
  .event-chip .count {
    background: rgba(0,0,0,0.2);
    padding: 0.1rem 0.3rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
  }
  .dsl-token {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 0.2rem 0.4rem;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    margin: 0.1rem;
    display: inline-block;
  }
  .dsl-operator {
    color: #6f42c1;
    font-weight: bold;
    margin: 0 0.25rem;
  }

  /* Tooltip and truncation styles */
  .copyable-text {
    cursor: pointer;
  }
  .copy-tooltip {
    display: none;
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    z-index: 1000;
    max-width: 400px;
    white-space: normal;
    word-break: break-word;
    top: 100%;
    left: 0;
    margin-top: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .copyable-text:hover .copy-tooltip,
  .position-relative:hover .copy-tooltip {
    display: block;
  }
  .copied-feedback {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 1100;
  }

  /* Table row hover effect */
  .table tbody tr:hover {
    background-color: rgba(0,0,0,0.075);
  }

  /* Print styles */
  @media print {

    .btn,
    .navbar,
    .footer {
      display: none !important;
    }

    .main-container {
      box-shadow: none !important;
      background: white !important;
    }

    .stats-card {
      background: #f8f9fa !important;
      color: #333 !important;
      border: 1px solid #dee2e6 !important;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Guardar temp_id para usar el int√©rprete y otras llamadas
  sessionStorage.setItem('json_temp_id', '{{ results.temp_id }}');

  (function () {
    const tempId = '{{ results.temp_id }}';
    const dslInput = document.getElementById('dslInput');
    const runBtn = document.getElementById('runQueryBtn');
    const exportXlsxBtn = document.getElementById('exportXlsxBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const presets = document.querySelectorAll('.preset');
    const tableWrap = document.getElementById('queryTableWrap');
    const table = document.getElementById('queryTable');
    const metaDiv = document.getElementById('queryMeta');
    const catalogOut = document.getElementById('catalogOut');

    presets.forEach(b => b.addEventListener('click', () => { dslInput.value = b.dataset.dsl || ''; }));

    let dataTable = null;
    let allQueryData = []; // Store all data for "show all" functionality
    let currentQueryDsl = ''; // Store current query for re-fetching
    let eventDiscovery = {}; // Store discovered event types
    let dslBuilderState = {
      eventNames: [],
      statuses: [],
      fireStatuses: [],
      operator: 'and'
    };

    function renderRows(rows, shouldStoreAllData = false) {
      console.log('üéØ renderRows CALLED with:', rows ? rows.length : 0, 'rows');
      console.log('üéØ renderRows - shouldStoreAllData:', shouldStoreAllData);
      console.log('üéØ renderRows - First row sample:', rows && rows.length > 0 ? rows[0] : 'No rows');
      
      if (!rows || rows.length === 0) { 
        console.log('‚ö†Ô∏è renderRows - No rows to render, hiding table');
        tableWrap.style.display = 'none'; 
        table.innerHTML = ''; 
        return; 
      }
      
      console.log('‚úÖ renderRows - Proceeding with rendering', rows.length, 'rows');
      
      // Only store all data if explicitly requested (not on limited loads)
      if (shouldStoreAllData) {
        allQueryData = rows;
      }
      
      // Destroy existing DataTable if it exists
      if (dataTable) {
        console.log('üîÑ Destroying existing DataTable');
        dataTable.destroy();
        dataTable = null;
      }
      
      // Get all columns first
      const allCols = [...new Set(rows.flatMap(r => Object.keys(r)))];
      console.log('üîç DEBUG - All columns found:', allCols);
      console.log('üîç DEBUG - Total columns count:', allCols.length);
      
      // Check specifically for contact fields
      const contactFields = allCols.filter(col => col.includes('contact'));
      console.log('üîç DEBUG - Contact fields found:', contactFields);

      // Define columns to exclude from grid display (but keep in exports)
      const excludedCols = [
        'isfire_root', 'event_name_root', 'isfire_bool',
        'fbc', 'fbp', 'ip_address', 'landing_url', 'user_agent',
        'utm_campaign', 'utm_content', 'utm_medium', 'utm_source',
        'updated_by_name'
      ];
      
      // Filter out excluded columns
      const cols = allCols.filter(col => !excludedCols.includes(col));
      console.log('üîç DEBUG - Columns after exclusion filter:', cols);
      console.log('üîç DEBUG - Excluded columns:', excludedCols);
      console.log('üîç DEBUG - Contact fields in final cols:', cols.filter(col => col.includes('contact')));
      
      // Helper function to truncate text
      function truncateText(text, maxLength = 100) {
        if (text && text.length > maxLength) {
          return text.substring(0, maxLength) + '...';
        }
        return text;
      }

      // Create column definitions for DataTables
      const columns = cols.map(col => ({
        data: col,
        title: col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        className: col === 'date' ? 'text-nowrap' : 'text-break position-relative',
        render: function(data, type, row) {
          if (type === 'display') {
            if (data == null) return '';
            
            // Format date column
            if (col === 'date' && data) {
              try {
                const date = new Date(data);
                return new Intl.DateTimeFormat('es-MX', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                }).format(date);
              } catch (e) {
                return data;
              }
            }

            // Format URLs as links
            if ((col === 'event_url' || col === 'zap_url') && data) {
              try {
                const url = new URL(data);
                const truncatedUrl = truncateText(url.pathname, 30);
                return `<div class="position-relative">
                  <a href="${data}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                    <i class="fas fa-external-link-alt me-1"></i>${url.hostname}${truncatedUrl}
                  </a>
                  <div class="copy-tooltip" role="tooltip">${data}</div>
                </div>`;
              } catch (e) {
                return data;
              }
            }
            
            // Email as link
            if (col === 'email' && data) {
              return `<a href="mailto:${data}" class="text-truncate d-inline-block">
                <i class="fas fa-envelope me-1"></i>${data}
              </a>`;
            }

            // Contact name
            if (col === 'contact_name' && data) {
              return `<div class="d-flex align-items-center">
                <i class="fas fa-user me-1 text-info"></i>${data}
              </div>`;
            }

            // Phone number with formatting
            if (col === 'contact_phone' && data) {
              // Try to format phone number nicely
              let displayPhone = data;
              if (data.startsWith('+1') && data.length === 12) {
                // US phone number formatting: +1 (XXX) XXX-XXXX
                displayPhone = `+1 (${data.slice(2,5)}) ${data.slice(5,8)}-${data.slice(8)}`;
              }
              return `<div class="d-flex align-items-center">
                <i class="fas fa-phone me-1 text-success"></i>
                <a href="tel:${data}" class="text-decoration-none">${displayPhone}</a>
              </div>`;
            }

            // Phone country with flag
            if (col === 'contact_phone_country' && data) {
              // Add country flag emoji if available
              const countryFlags = {
                'US': 'üá∫üá∏',
                'CA': 'üá®üá¶',
                'MX': 'üá≤üáΩ',
                'GB': 'üá¨üáß',
                'AU': 'üá¶üá∫',
                'DE': 'üá©üá™',
                'FR': 'üá´üá∑',
                'IT': 'üáÆüáπ',
                'ES': 'üá™üá∏',
                'BR': 'üáßüá∑',
                'AR': 'üá¶üá∑',
                'IN': 'üáÆüá≥',
                'CN': 'üá®üá≥',
                'JP': 'üáØüáµ',
                'KR': 'üá∞üá∑'
              };
              const flag = countryFlags[data] || 'üåç';
              return `<div class="d-flex align-items-center">
                <span class="me-1">${flag}</span>${data}
              </div>`;
            }

            // Default truncation for other columns
            const fullText = String(data);
            if (fullText.length > 100) {
              return `<div class="position-relative copyable-text" data-full-text="${fullText}">
                <span>${truncateText(fullText)}</span>
                <div class="copy-tooltip" role="tooltip">${fullText}</div>
              </div>`;
            }
          }
          return data;
        }
      }));

      // Clear and recreate table structure
      console.log('üìä Creating table with', rows.length, 'rows and', columns.length, 'columns');
      table.innerHTML = '';
      tableWrap.style.display = '';
      console.log('‚úÖ Table wrapper display set to visible');
      
      // Initialize DataTable with enhanced features
      console.log('üîß Initializing DataTable...');
      
      try {
        dataTable = $(table).DataTable({
        data: rows,
        columns: columns,
        pageLength: 15,
        lengthMenu: [[10, 15, 25, 50, -1], [10, 15, 25, 50, "All"]],
        ordering: true,
        searching: true,
        paging: true,
        info: true,
        responsive: true,
        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"l><"col-sm-12 col-md-7"p>>',
        buttons: [
          {
            extend: 'collection',
            text: '<i class="fas fa-download me-1"></i>Export',
            buttons: [
              {
                extend: 'copy',
                text: '<i class="fas fa-copy me-1"></i>Copy',
                className: 'btn btn-sm'
              },
              {
                extend: 'excel',
                text: '<i class="fas fa-file-excel me-1"></i>Excel',
                className: 'btn btn-sm'
              },
              {
                extend: 'csv',
                text: '<i class="fas fa-file-csv me-1"></i>CSV',
                className: 'btn btn-sm'
              },
              {
                extend: 'print',
                text: '<i class="fas fa-print me-1"></i>Print',
                className: 'btn btn-sm'
              }
            ],
            className: 'btn btn-secondary'
          }
        ],
        order: [[cols.indexOf('date') >= 0 ? cols.indexOf('date') : 0, 'desc']], // Sort by date desc by default
        language: {
          search: "üîç Search:",
          lengthMenu: "Show _MENU_ entries",
          zeroRecords: "No matching records found",
          info: "Showing _START_ to _END_ of _TOTAL_ entries",
          infoEmpty: "Showing 0 to 0 of 0 entries",
          infoFiltered: "(filtered from _MAX_ total entries)",
          paginate: {
            first: "First",
            last: "Last",
            next: "Next",
            previous: "Previous"
          }
        },
        initComplete: function() {
          // Table is ready - no additional column search needed
          // The main search box will handle all searching
          console.log('‚úÖ DataTable initialization complete!');
          console.log('üìä Table now showing', this.api().rows().count(), 'rows');
        }
      });

      // Handle "Show All" functionality
      dataTable.on('length.dt', function(e, settings, len) {
        if (len === -1 && rows.length < allQueryData.length) {
          // User selected "All" but we're showing limited data
          // Show loading message
          metaDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Loading all records...</div>`;
          
          // Re-render with all data
          setTimeout(() => {
            renderRows(allQueryData, false);
            metaDiv.innerHTML = `
              <div class="alert alert-success">
                <div><strong>Results:</strong> ${allQueryData.length} (showing all records)</div>
              </div>`;
          }, 100);
        }
      });

      // Add click-to-copy functionality
      $(table).on('click', '.copyable-text', function() {
        const text = $(this).data('full-text');
        navigator.clipboard.writeText(text).then(() => {
          // Show feedback
          const feedback = $('<div class="copied-feedback">Text copied to clipboard</div>');
          $('body').append(feedback);
          setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 2000);
        });
      });

      // Add custom complete export button
      const completeExportBtn = $('<button class="btn btn-success btn-sm ms-2"><i class="fas fa-file-excel me-1"></i>Export Complete Data</button>');
      $(tableWrap).find('.dt-buttons').append(completeExportBtn);
      
      completeExportBtn.on('click', function() {
        // Export all data including hidden columns - use allQueryData instead of rows
        const exportData = allQueryData.length > 0 ? allQueryData : rows;
        console.log('üîç DEBUG - Export: Total rows to export:', exportData.length);
        console.log('üîç DEBUG - Export: Sample row keys:', exportData.length > 0 ? Object.keys(exportData[0]) : 'No data');
        console.log('üîç DEBUG - Export: allCols for export:', allCols);
        
        const allData = exportData.map(row => {
          const exportRow = {};
          allCols.forEach(col => {
            const displayName = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            exportRow[displayName] = row[col] || '';
          });
          return exportRow;
        });
        
        console.log('üîç DEBUG - Export: Sample export row keys:', Object.keys(allData[0] || {}));
        console.log('üîç DEBUG - Export: Contact fields in export:', Object.keys(allData[0] || {}).filter(key => key.toLowerCase().includes('contact')));
        
        // Create Excel file
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Complete Data');
        
        // Auto-size columns
        const colWidths = [];
        Object.keys(allData[0] || {}).forEach((key, i) => {
          const maxLength = Math.max(
            key.length,
            ...allData.map(row => String(row[key] || '').length)
          );
          colWidths.push({ wch: Math.min(maxLength + 2, 50) });
        });
        ws['!cols'] = colWidths;
        
        // Download file
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        XLSX.writeFile(wb, `complete_data_${timestamp}.xlsx`);
        
        // Show feedback
        const totalExported = allQueryData.length > 0 ? allQueryData.length : rows.length;
        const feedback = $(`<div class="copied-feedback">Complete Excel exported successfully (${totalExported} records)</div>`);
        $('body').append(feedback);
        setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 3000);
      });
      
      console.log('‚úÖ renderRows completed successfully!');
      
      } catch (error) {
        console.error('‚ùå ERROR in DataTable creation:', error);
        console.error('Stack trace:', error.stack);
        metaDiv.innerHTML = `<div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error creating table: ${error.message}
        </div>`;
      }
    }

    let currentQueryId = null;
    let progressCheckInterval = null;

    async function runQuery(exportFmt) {
      console.log('üöÄ runQuery called with exportFmt:', exportFmt);
      
      try {
        const dsl = (dslInput.value || '').trim();
        console.log('üìù DSL:', dsl);
        if (!dsl) { alert('Write a DSL query'); return; }
        
        currentQueryDsl = dsl; // Store current query
        metaDiv.innerHTML = `<div class="alert alert-info">
          <i class="fas fa-spinner fa-spin me-2"></i>Analyzing dataset and preparing query...
          <div class="progress mt-2" style="height: 20px;">
            <div id="queryProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 15%">
              <span class="fw-bold">Loading...</span>
            </div>
          </div>
        </div>`;
        console.log('‚úÖ Initial loading message displayed');

      if (!exportFmt) {
        // El backend autom√°ticamente usa preview para datasets grandes
        console.log('üì° Sending query request to backend...');
        const res = await fetch('/api/query', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ temp_id: tempId, dsl }) 
        });
        console.log('üì° Response received, status:', res.status, res.ok);
        
        const data = await res.json();
        console.log('üîç DEBUG - Full API Response:', data);
        console.log('üîç DEBUG - data.result:', data.result);
        console.log('üîç DEBUG - data.result.rows:', data.result ? data.result.rows : 'NO RESULT');
        
        if (!res.ok || data.error) { 
          metaDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown'}</div>`; 
          renderRows([]); 
          return; 
        }
        
        const result = data.result || {};
        const allRows = result.rows || [];
        currentQueryId = data.query_id;
        
        console.log('üîç DEBUG - API Response: Total rows received:', allRows.length);
        console.log('üîç DEBUG - Processing status:', data.processing ? 'Background processing' : 'Complete');
        console.log('üîç DEBUG - Query ID:', currentQueryId);
        console.log('üîç DEBUG - Sample row:', allRows.length > 0 ? allRows[0] : 'No rows');
        
        // Define variables for use in both preview and complete modes
        const initialLoadLimit = 100;
        const initialRows = allRows.slice(0, initialLoadLimit);
        const hasMore = allRows.length > initialLoadLimit;
        
        // Mostrar resultados inmediatamente SI HAY FILAS
        if (allRows.length > 0) {
          allQueryData = allRows;
          
          console.log('üîç DEBUG - Calling renderRows with', initialRows.length, 'rows');
          renderRows(initialRows, false);
          console.log('üîç DEBUG - renderRows completed');
        } else {
          console.log('‚ö†Ô∏è WARNING - No rows returned in preview!');
        }
        
        // Si est√° procesando en background, mostrar mensaje y polling
        if (data.processing) {
          const totalEvents = data.total_events || 'unknown';
          const shownRows = allRows.length;
          
          console.log('üîç DEBUG - Entering preview mode UI update');
          console.log('üîç DEBUG - Total events:', totalEvents, '| Preview rows:', shownRows);
          
          if (shownRows > 0) {
            metaDiv.innerHTML = `
            <div class="alert alert-success border-info">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <i class="fas fa-check-circle me-2 text-success"></i>
                  <strong>Quick Preview Ready!</strong> Showing first ${shownRows} results
                </div>
                <span class="badge bg-success">${shownRows} rows loaded</span>
              </div>
              <div class="alert alert-info mb-0 p-2">
                <div class="d-flex align-items-center">
                  <i class="fas fa-spinner fa-spin me-2"></i>
                  <span class="small">Processing full dataset in background (${totalEvents} events total)...</span>
                </div>
                <div class="progress mt-2" style="height: 22px;">
                  <div id="queryProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                       role="progressbar" style="width: 25%">
                    <span class="fw-bold">25% - Loading data...</span>
                  </div>
                </div>
                <div class="text-muted small mt-1">
                  <i class="fas fa-bolt me-1"></i>Table will auto-update when complete. You can export now or wait for full results.
                </div>
              </div>
            </div>`;
            
            // Iniciar polling para checkear progreso
            startProgressPolling(data.query_id);
          } else {
            // Preview pero sin rows - mostrar solo loader
            console.log('‚ö†Ô∏è WARNING - Preview mode but no rows!');
            metaDiv.innerHTML = `
            <div class="alert alert-info">
              <div class="d-flex align-items-center">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <span>Processing dataset (${totalEvents} events total)...</span>
              </div>
              <div class="progress mt-2" style="height: 22px;">
                <div id="queryProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                     role="progressbar" style="width: 25%">
                  <span class="fw-bold">25% - Loading data...</span>
                </div>
              </div>
            </div>`;
            startProgressPolling(data.query_id);
          }
        } else {
          // Query completo
          let infoText = `<div><strong>Results:</strong> ${allRows.length} total`;
          if (hasMore) {
            infoText += ` (showing first ${initialRows.length} for performance)`;
          }
          infoText += `</div>`;
          
          metaDiv.innerHTML = `
          <div class="alert alert-success">
            ${infoText}
            ${result.meta?.group_by ? `<div><strong>Group by:</strong> ${result.meta.group_by.join(', ')}</div>` : ''}
            ${result.meta?.count ? `<div><strong>Count:</strong> Yes</div>` : ''}
            ${result.meta?.preview ? `<div class="text-warning"><i class="fas fa-info-circle me-1"></i>${result.meta.note}</div>` : ''}
            ${hasMore ? `<div class="text-muted small"><i class="fas fa-info-circle me-1"></i>Select "All" from page size dropdown to load all ${allRows.length} records</div>` : ''}
          </div>`;
        }
      } else {
        const res = await fetch('/api/export', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId, dsl, format: exportFmt }) });
        if (!res.ok) { const data = await res.json().catch(() => ({})); metaDiv.innerHTML = `<div class="alert alert-danger">Error exporting: ${data.error || res.statusText}</div>`; return; }
        const blob = await res.blob(); const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = exportFmt === 'csv' ? 'query.csv' : 'query.xlsx';
        document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
        metaDiv.innerHTML = `<div class="alert alert-success">File exported.</div>`;
      }
      
      } catch (error) {
        console.error('‚ùå CRITICAL ERROR in runQuery:', error);
        console.error('Stack trace:', error.stack);
        metaDiv.innerHTML = `<div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Error processing query:</strong> ${error.message}
          <div class="mt-2 small">Check browser console (F12) for details</div>
        </div>`;
      }
    }

    function startProgressPolling(queryId) {
      // Limpiar interval previo si existe
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
      }
      
      // Checkear progreso cada 2 segundos
      progressCheckInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/query/status/${queryId}`);
          const status = await res.json();
          
          if (status.status === 'complete') {
            clearInterval(progressCheckInterval);
            progressCheckInterval = null;
            
            // Actualizar con resultados completos
            const result = status.result || {};
            const allRows = result.rows || [];
            
            allQueryData = allRows;
            const initialLoadLimit = 100;
            const initialRows = allRows.slice(0, initialLoadLimit);
            renderRows(initialRows, false);
            
            metaDiv.innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Query completed!</strong> ${allRows.length} total results
              ${result.meta?.group_by ? `<div><strong>Group by:</strong> ${result.meta.group_by.join(', ')}</div>` : ''}
              ${result.meta?.count ? `<div><strong>Count:</strong> Yes</div>` : ''}
              ${allRows.length > initialLoadLimit ? `<div class="text-muted small"><i class="fas fa-info-circle me-1"></i>Showing first ${initialLoadLimit} for performance. Select "All" to load all records.</div>` : ''}
            </div>`;
          } else if (status.status === 'error') {
            clearInterval(progressCheckInterval);
            progressCheckInterval = null;
            metaDiv.innerHTML = `<div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>Error processing query: ${status.error || 'Unknown'}
            </div>`;
          } else {
            // Actualizar progreso
            const progress = status.progress || 25;
            const progressBar = document.getElementById('queryProgress');
            if (progressBar) {
              progressBar.style.width = `${progress}%`;
              
              // Mensaje seg√∫n el progreso
              let message = 'Processing...';
              if (progress <= 30) {
                message = 'Loading data...';
              } else if (progress <= 50) {
                message = 'Normalizing events...';
              } else if (progress <= 75) {
                message = 'Executing query...';
              } else {
                message = 'Almost done...';
              }
              
              progressBar.innerHTML = `<span class="fw-bold">${progress}% - ${message}</span>`;
            }
          }
        } catch (err) {
          console.error('Error checking query status:', err);
        }
      }, 2000); // Check every 2 seconds
    }

    runBtn.addEventListener('click', () => runQuery(null));
    
    // Only add export listeners if buttons exist
    if (exportXlsxBtn) {
      exportXlsxBtn.addEventListener('click', () => runQuery('xlsx'));
    }
    if (exportCsvBtn) {
      exportCsvBtn.addEventListener('click', () => runQuery('csv'));
    }

    // Event Discovery Functions
    function analyzeEventTypes() {
      const tempIdForAnalysis = '{{ results.temp_id }}';
      
      // Analyze the uploaded data for event discovery
      fetch('/api/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          temp_id: tempIdForAnalysis, 
          dsl: 'select *' // Get all data for analysis
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.result && data.result.rows) {
          processEventDiscovery(data.result.rows);
          displayEventDiscovery();
          document.getElementById('eventDiscoveryCard').style.display = 'block';
        }
      })
      .catch(err => console.error('Event analysis failed:', err));
    }

    function processEventDiscovery(rows) {
      const eventNames = {};
      const statuses = {};
      const fireStatuses = {};
      const dates = [];

      rows.forEach(row => {
        // Count event names
        if (row.event_name) {
          eventNames[row.event_name] = (eventNames[row.event_name] || 0) + 1;
        }
        
        // Count statuses
        if (row.status) {
          statuses[row.status] = (statuses[row.status] || 0) + 1;
        }
        
        // Count fire statuses
        if (row.isfire) {
          fireStatuses[row.isfire] = (fireStatuses[row.isfire] || 0) + 1;
        }
        
        // Collect dates
        if (row.date) {
          dates.push(new Date(row.date));
        }
      });

      eventDiscovery = {
        eventNames: Object.entries(eventNames).sort((a, b) => b[1] - a[1]),
        statuses: Object.entries(statuses).sort((a, b) => b[1] - a[1]),
        fireStatuses: Object.entries(fireStatuses).sort((a, b) => b[1] - a[1]),
        dateRange: dates.length > 0 ? {
          min: new Date(Math.min(...dates)),
          max: new Date(Math.max(...dates)),
          count: dates.length
        } : null,
        totalRows: rows.length
      };
    }

    function displayEventDiscovery() {
      // Display event names
      const eventNamesContainer = document.getElementById('eventNamesList');
      const eventNameCount = document.getElementById('eventNameCount');
      eventNameCount.textContent = eventDiscovery.eventNames.length;
      
      eventNamesContainer.innerHTML = eventDiscovery.eventNames
        .map(([name, count]) => 
          `<span class="event-chip" data-type="event_name" data-value="${name}">
            <i class="fas fa-tag"></i> ${name} <span class="count">${count}</span>
          </span>`
        ).join('');

      // Display statuses
      const statusContainer = document.getElementById('statusList');
      const statusCount = document.getElementById('statusCount');
      statusCount.textContent = eventDiscovery.statuses.length;
      
      statusContainer.innerHTML = eventDiscovery.statuses
        .map(([status, count]) => 
          `<span class="event-chip" data-type="status" data-value="${status}">
            <i class="fas fa-circle"></i> ${status} <span class="count">${count}</span>
          </span>`
        ).join('');

      // Display fire statuses
      const fireContainer = document.getElementById('fireStatusList');
      const fireCount = document.getElementById('fireStatusCount');
      fireCount.textContent = eventDiscovery.fireStatuses.length;
      
      fireContainer.innerHTML = eventDiscovery.fireStatuses
        .map(([fire, count]) => 
          `<span class="event-chip" data-type="isfire" data-value="${fire}">
            <i class="fas fa-${fire === 'yes' ? 'fire' : 'ban'}"></i> ${fire} <span class="count">${count}</span>
          </span>`
        ).join('');

      // Display date range
      const dateRangeInfo = document.getElementById('dateRangeInfo');
      if (eventDiscovery.dateRange) {
        const { min, max, count } = eventDiscovery.dateRange;
        dateRangeInfo.innerHTML = `
          <div><strong>${count}</strong> records from:</div>
          <div><i class="fas fa-calendar-alt me-1"></i>${min.toLocaleDateString()} to ${max.toLocaleDateString()}</div>
        `;
      } else {
        dateRangeInfo.innerHTML = '<div class="text-muted">No date information available</div>';
      }

      // Add click handlers for chips
      document.querySelectorAll('.event-chip').forEach(chip => {
        chip.addEventListener('click', function() {
          const type = this.dataset.type;
          const value = this.dataset.value;
          toggleChipSelection(this, type, value);
          updateDslBuilder();
        });
      });
    }

    function toggleChipSelection(chipElement, type, value) {
      chipElement.classList.toggle('active');
      
      if (chipElement.classList.contains('active')) {
        // Add to builder state
        if (type === 'event_name' && !dslBuilderState.eventNames.includes(value)) {
          dslBuilderState.eventNames.push(value);
        } else if (type === 'status' && !dslBuilderState.statuses.includes(value)) {
          dslBuilderState.statuses.push(value);
        } else if (type === 'isfire' && !dslBuilderState.fireStatuses.includes(value)) {
          dslBuilderState.fireStatuses.push(value);
        }
      } else {
        // Remove from builder state
        if (type === 'event_name') {
          dslBuilderState.eventNames = dslBuilderState.eventNames.filter(v => v !== value);
        } else if (type === 'status') {
          dslBuilderState.statuses = dslBuilderState.statuses.filter(v => v !== value);
        } else if (type === 'isfire') {
          dslBuilderState.fireStatuses = dslBuilderState.fireStatuses.filter(v => v !== value);
        }
      }
    }

    function updateDslBuilder() {
      const builderDiv = document.getElementById('dslBuilder');
      const conditions = [];

      // Build event name conditions
      if (dslBuilderState.eventNames.length > 0) {
        if (dslBuilderState.eventNames.length === 1) {
          conditions.push(`event_name == "${dslBuilderState.eventNames[0]}"`);
        } else {
          const eventConditions = dslBuilderState.eventNames.map(name => `event_name == "${name}"`);
          conditions.push(`(${eventConditions.join(' or ')})`);
        }
      }

      // Build status conditions
      if (dslBuilderState.statuses.length > 0) {
        if (dslBuilderState.statuses.length === 1) {
          conditions.push(`status == "${dslBuilderState.statuses[0]}"`);
        } else {
          const statusConditions = dslBuilderState.statuses.map(status => `status == "${status}"`);
          conditions.push(`(${statusConditions.join(' or ')})`);
        }
      }

      // Build fire status conditions
      if (dslBuilderState.fireStatuses.length > 0) {
        if (dslBuilderState.fireStatuses.length === 1) {
          conditions.push(`isfire == "${dslBuilderState.fireStatuses[0]}"`);
        } else {
          const fireConditions = dslBuilderState.fireStatuses.map(fire => `isfire == "${fire}"`);
          conditions.push(`(${fireConditions.join(' or ')})`);
        }
      }

      // Build final DSL
      let dsl = '';
      if (conditions.length > 0) {
        dsl = `where ${conditions.join(' and ')} | select *`;
      }

      if (dsl) {
        builderDiv.innerHTML = `
          <div class="dsl-preview">
            <code class="dsl-token">${dsl}</code>
          </div>
        `;
      } else {
        builderDiv.innerHTML = '<span class="text-muted">Click on event types above to build your query...</span>';
      }
    }

    // DSL Builder controls
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('clearBuilderBtn').addEventListener('click', function() {
        // Clear all selections
        dslBuilderState = { eventNames: [], statuses: [], fireStatuses: [], operator: 'and' };
        document.querySelectorAll('.event-chip.active').forEach(chip => {
          chip.classList.remove('active');
        });
        updateDslBuilder();
      });

      document.getElementById('useBuiltQueryBtn').addEventListener('click', function() {
        const builderDiv = document.getElementById('dslBuilder');
        const dslCode = builderDiv.querySelector('code.dsl-token');
        if (dslCode) {
          dslInput.value = dslCode.textContent;
          // Scroll to query input
          dslInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          dslInput.focus();
        }
      });

      // Auto-analyze events when page loads
      setTimeout(() => {
        analyzeEventTypes();
      }, 1000);
    });
  })();
</script>
{% endblock %}