{% extends "base.html" %}
{% block title %}Analysis Results - JSON Event Analyzer{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary mb-3">
        <i class="fas fa-chart-bar me-3"></i>Data Analysis Dashboard
      </h1>
      <p class="lead text-muted">Interactive analysis for <strong>{{ results.filename }}</strong></p>
    </div>

    <!-- File Summary -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="card-title mb-0">
              <i class="fas fa-database me-2"></i>Dataset Overview
            </h5>
            <p class="text-muted mb-0">
              <strong>{{ results.total_events }}</strong> events loaded and ready for analysis
            </p>
          </div>
          <div class="col-md-4 text-end">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
              <i class="fas fa-file-code fa-2x text-primary"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Data Query Engine -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="card-title mb-0">
          <i class="fas fa-search me-2"></i>Interactive Query Engine
        </h4>
        <p class="mb-0 opacity-75">Analyze your data using natural language queries</p>
      </div>
      <div class="card-body">
        
        <!-- Query Input -->
        <div class="row mb-3">
          <div class="col-md-8">
            <label class="form-label fw-bold">Query</label>
            <textarea id="dslInput" class="form-control" rows="2"
              placeholder="where event_name == 'Schedule' and isfire == 'yes' | select *"></textarea>
          </div>
          <div class="col-md-4 d-flex flex-column">
            <label class="form-label fw-bold">Actions</label>
            <div class="d-flex gap-2 flex-wrap">
              <button id="runQueryBtn" class="btn btn-primary flex-grow-1">
                <i class="fas fa-play me-1"></i>Run Query
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Examples -->
        <div class="mb-3">
          <label class="form-label fw-bold">Quick Examples</label>
          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="select *">
              📋 View All Data
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where event_name == 'Schedule' and isfire == 'yes' | select *">
              🎯 Schedule + Fired Events
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where event_name == 'Schedule' and isfire == 'yes' | count by status">
              📊 Count by Status
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where isfire == 'yes' | group by status">
              📈 Fired Events by Status
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm preset"
              data-dsl="where isfire == 'yes' | count by event_name | limit 10">
              🔥 Top 10 Fired Events
            </button>
          </div>
        </div>

        <!-- Query Help -->
        <div class="alert alert-info">
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-lightbulb me-1"></i>Query Syntax Examples:</h6>
              <ul class="mb-0 small">
                <li><code>where event_name == "Schedule"</code> - Filter by event name</li>
                <li><code>where isfire == "yes"</code> - Filter by fired events</li>
                <li><code>where status == "success"</code> - Filter by status</li>
                <li><code>select *</code> - Show all columns</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6><i class="fas fa-chart-bar me-1"></i>Aggregation Examples:</h6>
              <ul class="mb-0 small">
                <li><code>count by status</code> - Count events by status</li>
                <li><code>group by event_name</code> - Group by event name</li>
                <li><code>limit 20</code> - Show only first 20 results</li>
                <li><code>offset 10</code> - Skip first 10 results</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Query Results -->
        <div id="queryMeta" class="mt-3"></div>
        <div class="table-responsive mt-3" id="queryTableWrap" style="display:none;">
          <table class="table table-sm table-striped table-hover" id="queryTable"></table>
        </div>

        <pre id="catalogOut" class="bg-light p-2 rounded mt-3"
          style="max-height:250px; overflow:auto; display:none;"></pre>
      </div>
    </div>


    <div class="text-center mt-4">
      <a href="{{ url_for('index') }}" class="btn btn-primary me-2">
        <i class="fas fa-arrow-left me-2"></i>Analyze Another File
      </a>
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Print Results
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* DataTables custom styling */
  .dataTables_wrapper .dt-buttons {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .dataTables_filter {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .table thead th {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    white-space: nowrap;
  }
  .dataTables_wrapper .btn-group > .btn {
    margin: 0.25rem;
  }
  .dataTables_info {
    padding-top: 0.5rem !important;
  }
  .dataTables_paginate .pagination {
    margin: 0;
  }

  /* Tooltip and truncation styles */
  .copyable-text {
    cursor: pointer;
  }
  .copy-tooltip {
    display: none;
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    z-index: 1000;
    max-width: 400px;
    white-space: normal;
    word-break: break-word;
    top: 100%;
    left: 0;
    margin-top: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .copyable-text:hover .copy-tooltip,
  .position-relative:hover .copy-tooltip {
    display: block;
  }
  .copied-feedback {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 1100;
  }

  /* Table row hover effect */
  .table tbody tr:hover {
    background-color: rgba(0,0,0,0.075);
  }

  /* Print styles */
  @media print {

    .btn,
    .navbar,
    .footer {
      display: none !important;
    }

    .main-container {
      box-shadow: none !important;
      background: white !important;
    }

    .stats-card {
      background: #f8f9fa !important;
      color: #333 !important;
      border: 1px solid #dee2e6 !important;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Guardar temp_id para usar el intérprete y otras llamadas
  sessionStorage.setItem('json_temp_id', '{{ results.temp_id }}');

  (function () {
    const tempId = '{{ results.temp_id }}';
    const dslInput = document.getElementById('dslInput');
    const runBtn = document.getElementById('runQueryBtn');
    const exportXlsxBtn = document.getElementById('exportXlsxBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const presets = document.querySelectorAll('.preset');
    const tableWrap = document.getElementById('queryTableWrap');
    const table = document.getElementById('queryTable');
    const metaDiv = document.getElementById('queryMeta');
    const catalogOut = document.getElementById('catalogOut');

    presets.forEach(b => b.addEventListener('click', () => { dslInput.value = b.dataset.dsl || ''; }));

    let dataTable = null;
    let allQueryData = []; // Store all data for "show all" functionality
    let currentQueryDsl = ''; // Store current query for re-fetching

    function renderRows(rows, shouldStoreAllData = false) {
      if (!rows || rows.length === 0) { 
        tableWrap.style.display = 'none'; 
        table.innerHTML = ''; 
        return; 
      }
      
      // Only store all data if explicitly requested (not on limited loads)
      if (shouldStoreAllData) {
        allQueryData = rows;
      }
      
      // Destroy existing DataTable if it exists
      if (dataTable) {
        dataTable.destroy();
        dataTable = null;
      }
      
      // Get all columns first
      const allCols = [...new Set(rows.flatMap(r => Object.keys(r)))];
      
      // Define columns to exclude from grid display (but keep in exports)
      const excludedCols = [
        'isfire_root', 'event_name_root', 'isfire_bool',
        'fbc', 'fbp', 'ip_address', 'landing_url', 'user_agent',
        'utm_campaign', 'utm_content', 'utm_medium', 'utm_source',
        'updated_by_name'
      ];
      
      // Filter out excluded columns
      const cols = allCols.filter(col => !excludedCols.includes(col));
      
      // Helper function to truncate text
      function truncateText(text, maxLength = 100) {
        if (text && text.length > maxLength) {
          return text.substring(0, maxLength) + '...';
        }
        return text;
      }

      // Create column definitions for DataTables
      const columns = cols.map(col => ({
        data: col,
        title: col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        className: col === 'date' ? 'text-nowrap' : 'text-break position-relative',
        render: function(data, type, row) {
          if (type === 'display') {
            if (data == null) return '';
            
            // Format date column
            if (col === 'date' && data) {
              try {
                const date = new Date(data);
                return new Intl.DateTimeFormat('es-MX', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                }).format(date);
              } catch (e) {
                return data;
              }
            }

            // Format URLs as links
            if ((col === 'event_url' || col === 'zap_url') && data) {
              try {
                const url = new URL(data);
                const truncatedUrl = truncateText(url.pathname, 30);
                return `<div class="position-relative">
                  <a href="${data}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                    <i class="fas fa-external-link-alt me-1"></i>${url.hostname}${truncatedUrl}
                  </a>
                  <div class="copy-tooltip" role="tooltip">${data}</div>
                </div>`;
              } catch (e) {
                return data;
              }
            }
            
            // Email as link
            if (col === 'email' && data) {
              return `<a href="mailto:${data}" class="text-truncate d-inline-block">
                <i class="fas fa-envelope me-1"></i>${data}
              </a>`;
            }

            // Default truncation for other columns
            const fullText = String(data);
            if (fullText.length > 100) {
              return `<div class="position-relative copyable-text" data-full-text="${fullText}">
                <span>${truncateText(fullText)}</span>
                <div class="copy-tooltip" role="tooltip">${fullText}</div>
              </div>`;
            }
          }
          return data;
        }
      }));

      // Clear and recreate table structure
      table.innerHTML = '';
      tableWrap.style.display = '';
      
      // Initialize DataTable with enhanced features
      dataTable = $(table).DataTable({
        data: rows,
        columns: columns,
        pageLength: 15,
        lengthMenu: [[10, 15, 25, 50, -1], [10, 15, 25, 50, "All"]],
        ordering: true,
        searching: true,
        paging: true,
        info: true,
        responsive: true,
        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"l><"col-sm-12 col-md-7"p>>',
        buttons: [
          {
            extend: 'collection',
            text: '<i class="fas fa-download me-1"></i>Export',
            buttons: [
              {
                extend: 'copy',
                text: '<i class="fas fa-copy me-1"></i>Copy',
                className: 'btn btn-sm'
              },
              {
                extend: 'excel',
                text: '<i class="fas fa-file-excel me-1"></i>Excel',
                className: 'btn btn-sm'
              },
              {
                extend: 'csv',
                text: '<i class="fas fa-file-csv me-1"></i>CSV',
                className: 'btn btn-sm'
              },
              {
                extend: 'print',
                text: '<i class="fas fa-print me-1"></i>Print',
                className: 'btn btn-sm'
              }
            ],
            className: 'btn btn-secondary'
          }
        ],
        order: [[cols.indexOf('date') >= 0 ? cols.indexOf('date') : 0, 'desc']], // Sort by date desc by default
        language: {
          search: "🔍 Search:",
          lengthMenu: "Show _MENU_ entries",
          zeroRecords: "No matching records found",
          info: "Showing _START_ to _END_ of _TOTAL_ entries",
          infoEmpty: "Showing 0 to 0 of 0 entries",
          infoFiltered: "(filtered from _MAX_ total entries)",
          paginate: {
            first: "First",
            last: "Last",
            next: "Next",
            previous: "Previous"
          }
        },
        initComplete: function() {
          // Table is ready - no additional column search needed
          // The main search box will handle all searching
        }
      });

      // Handle "Show All" functionality
      dataTable.on('length.dt', function(e, settings, len) {
        if (len === -1 && rows.length < allQueryData.length) {
          // User selected "All" but we're showing limited data
          // Show loading message
          metaDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Loading all records...</div>`;
          
          // Re-render with all data
          setTimeout(() => {
            renderRows(allQueryData, false);
            metaDiv.innerHTML = `
              <div class="alert alert-success">
                <div><strong>Results:</strong> ${allQueryData.length} (showing all records)</div>
              </div>`;
          }, 100);
        }
      });

      // Add click-to-copy functionality
      $(table).on('click', '.copyable-text', function() {
        const text = $(this).data('full-text');
        navigator.clipboard.writeText(text).then(() => {
          // Show feedback
          const feedback = $('<div class="copied-feedback">Text copied to clipboard</div>');
          $('body').append(feedback);
          setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 2000);
        });
      });

      // Add custom complete export button
      const completeExportBtn = $('<button class="btn btn-success btn-sm ms-2"><i class="fas fa-file-excel me-1"></i>Export Complete Data</button>');
      $(tableWrap).find('.dt-buttons').append(completeExportBtn);
      
      completeExportBtn.on('click', function() {
        // Export all data including hidden columns - use allQueryData instead of rows
        const exportData = allQueryData.length > 0 ? allQueryData : rows;
        const allData = exportData.map(row => {
          const exportRow = {};
          allCols.forEach(col => {
            const displayName = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            exportRow[displayName] = row[col] || '';
          });
          return exportRow;
        });
        
        // Create Excel file
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Complete Data');
        
        // Auto-size columns
        const colWidths = [];
        Object.keys(allData[0] || {}).forEach((key, i) => {
          const maxLength = Math.max(
            key.length,
            ...allData.map(row => String(row[key] || '').length)
          );
          colWidths.push({ wch: Math.min(maxLength + 2, 50) });
        });
        ws['!cols'] = colWidths;
        
        // Download file
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        XLSX.writeFile(wb, `complete_data_${timestamp}.xlsx`);
        
        // Show feedback
        const totalExported = allQueryData.length > 0 ? allQueryData.length : rows.length;
        const feedback = $(`<div class="copied-feedback">Complete Excel exported successfully (${totalExported} records)</div>`);
        $('body').append(feedback);
        setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 3000);
      });
    }

    async function runQuery(exportFmt) {
      const dsl = (dslInput.value || '').trim();
      if (!dsl) { alert('Write a DSL query'); return; }
      
      currentQueryDsl = dsl; // Store current query
      metaDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Processing...</div>`;

      if (!exportFmt) {
        const res = await fetch('/api/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId, dsl }) });
        const data = await res.json();
        if (!res.ok || data.error) { metaDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown'}</div>`; renderRows([]); return; }
        
        const result = data.result || {};
        const allRows = result.rows || [];
        
        // For initial load, limit to first 100 records for performance
        const initialLoadLimit = 100;
        const initialRows = allRows.slice(0, initialLoadLimit);
        const hasMore = allRows.length > initialLoadLimit;
        
        // Store all data first, then render limited data
        allQueryData = allRows;
        renderRows(initialRows, false); // Pass false so it doesn't overwrite allQueryData
        
        let infoText = `<div><strong>Results :</strong> ${allRows.length} total`;
        if (hasMore) {
          infoText += ` (showing first ${initialRows.length} for performance)`;
        }
        infoText += `</div>`;
        
        metaDiv.innerHTML = `
        <div class="alert alert-success">
          ${infoText}
          ${result.meta?.group_by ? `<div><strong>Group by:</strong> ${result.meta.group_by.join(', ')}</div>` : ''}
          ${result.meta?.count ? `<div><strong>Count:</strong> Yes</div>` : ''}
          ${hasMore ? `<div class="text-muted small"><i class="fas fa-info-circle me-1"></i>Select "All" from page size dropdown to load all ${allRows.length} records</div>` : ''}
        </div>`;
      } else {
        const res = await fetch('/api/export', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId, dsl, format: exportFmt }) });
        if (!res.ok) { const data = await res.json().catch(() => ({})); metaDiv.innerHTML = `<div class="alert alert-danger">Error exporting: ${data.error || res.statusText}</div>`; return; }
        const blob = await res.blob(); const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = exportFmt === 'csv' ? 'query.csv' : 'query.xlsx';
        document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
        metaDiv.innerHTML = `<div class="alert alert-success">File exported.</div>`;
      }
    }

    runBtn.addEventListener('click', () => runQuery(null));
    exportXlsxBtn.addEventListener('click', () => runQuery('xlsx'));
    exportCsvBtn.addEventListener('click', () => runQuery('csv'));
  })();
</script>
{% endblock %}