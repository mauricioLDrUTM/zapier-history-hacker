{% extends "base.html" %}
{% block title %}Analysis Results - JSON Event Analyzer{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary mb-3">
        <i class="fas fa-chart-bar me-3"></i>Analysis Results
      </h1>
      <p class="lead text-muted">Analysis completed for <strong>{{ results.filename }}</strong></p>
    </div>

    <!-- Parameters -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-cog me-2"></i>Analysis Parameters</h5>
        <div class="row">
          <div class="col-md-4"><strong>Filter Parameter:</strong> <span class="badge bg-primary">{{
              results.filter_param }}</span></div>
          <div class="col-md-4"><strong>Root ID:</strong> <span class="badge bg-secondary">{{ results.root_id }}</span>
          </div>
          <div class="col-md-4">
            <strong>Show IDs:</strong>
            <span class="badge bg-{{ 'success' if results.show_ids else 'warning' }}">{{ 'Yes' if results.show_ids else
              'No' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="stats-card text-center">
          <i class="fas fa-list-ol fa-2x mb-2"></i>
          <h3 class="mb-1">{{ results.total_events }}</h3>
          <p class="mb-0">Total Events</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card text-center">
          <i class="fas fa-check-circle fa-2x mb-2"></i>
          <h3 class="mb-1">{{ results.target_events }}</h3>
          <p class="mb-0">Target Events</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card text-center">
          <i class="fas fa-percentage fa-2x mb-2"></i>
          <h3 class="mb-1">{{ results.success_rate }}%</h3>
          <p class="mb-0">Success Rate</p>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Event Distribution</h5>
        <div class="progress mb-2" style="height: 30px;">
          <div class="progress-bar bg-success" role="progressbar"
            style="width: {{ (results.target_events / results.total_events * 100) if results.total_events > 0 else 0 }}%">
            {{ results.target_events }} Target Events
          </div>
          <div class="progress-bar bg-warning" role="progressbar"
            style="width: {{ ((results.total_events - results.target_events) / results.total_events * 100) if results.total_events > 0 else 0 }}%">
            {{ results.total_events - results.target_events }} Failed Events
          </div>
        </div>
      </div>
    </div>

    <!-- Raw Output (compat) -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-code me-2"></i>Raw Output</h5>
        <pre class="bg-light p-3 rounded"
          style="max-height: 220px; overflow-y: auto;">{{ results.output_content }}</pre>
      </div>
    </div>

    {% if results.show_ids %}
    <!-- Event IDs -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-check-circle me-2"></i>Target Event IDs
              <span class="badge bg-light text-success ms-2">{{ results.target_event_ids|length }}</span>
            </h5>
          </div>
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if results.target_event_ids %}
            <div class="list-group list-group-flush">
              {% for event_id in results.target_event_ids %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{{ url_for('event_detail', temp_id=results.temp_id, event_id=event_id) }}"
                  class="text-decoration-none">
                  <code class="text-primary">{{ event_id }}</code>
                </a>
                <span class="badge bg-success rounded-pill">Match</span>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center">No target events found</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">
              <i class="fas fa-times-circle me-2"></i>Failed Event IDs
              <span class="badge bg-light text-warning ms-2">{{ results.failed_event_ids|length }}</span>
            </h5>
          </div>
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if results.failed_event_ids %}
            <div class="list-group list-group-flush">
              {% for event_id in results.failed_event_ids %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{{ url_for('event_detail', temp_id=results.temp_id, event_id=event_id) }}"
                  class="text-decoration-none">
                  <code class="text-primary">{{ event_id }}</code>
                </a>
                <span class="badge bg-warning rounded-pill">No Match</span>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center">No failed events found</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-terminal me-2"></i>Interpreter (DSL)</h5>

        <div class="mb-2">
          <label class="form-label fw-bold">Query</label>
          <textarea id="dslInput" class="form-control" rows="3"
            placeholder='where event_name == "Schedule" and isfire == "yes" | count by status'></textarea>
          <div class="form-text">
            Examples:
            <code>where event_name == "Schedule" and isfire == "yes" | select *</code> ¬∑
            <code>where event_name == "Schedule" and isfire == "yes" | count by status</code> ¬∑
            <code>where isfire == "yes" | group by status</code>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-3">
          <button type="button" class="btn btn-outline-primary btn-sm preset"
            data-dsl='where event_name == "Schedule" and isfire == "yes" | select *'>
            Preset: Schedule + isFire
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm preset"
            data-dsl='where event_name == "Schedule" and isfire == "yes" | count by status'>
            Preset: Count by Status
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm preset"
            data-dsl='where isfire == "yes" | group by status'>
            Preset: Group by Status
          </button>
          <!-- <button id="catalogBtn" class="btn btn-outline-info btn-sm">
            <i class="fas fa-book me-2"></i>View Catalog
          </button> -->
        </div>

        <div class="d-flex gap-2">
          <button id="runQueryBtn" class="btn btn-primary">
            <i class="fas fa-play me-2"></i>Run
          </button>
  
        </div>

        <div id="queryMeta" class="mt-3"></div>
        <div class="table-responsive mt-2" id="queryTableWrap" style="display:none;">
          <table class="table table-sm table-striped table-hover" id="queryTable"></table>
        </div>

        <pre id="catalogOut" class="bg-light p-2 rounded mt-3"
          style="max-height:250px; overflow:auto; display:none;"></pre>
      </div>
    </div>


    <div class="text-center mt-4">
      <a href="{{ url_for('index') }}" class="btn btn-primary me-2">
        <i class="fas fa-arrow-left me-2"></i>Analyze Another File
      </a>
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Print Results
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* DataTables custom styling */
  .dataTables_wrapper .dt-buttons {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .dataTables_filter {
    margin-bottom: 1rem;
  }
  .dataTables_wrapper .table thead th {
    position: relative;
    padding-top: 3rem;  /* Space for the filter input */
  }
  .dataTables_wrapper .table thead th input {
    position: absolute;
    top: 0.5rem;
    left: 0;
    width: 100%;
    padding: 0.25rem;
  }
  .dataTables_wrapper .btn-group > .btn {
    margin: 0.25rem;
  }
  .dataTables_info {
    padding-top: 0.5rem !important;
  }

  /* Tooltip and truncation styles */
  .copyable-text {
    cursor: pointer;
  }
  .copy-tooltip {
    display: none;
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    z-index: 1000;
    max-width: 400px;
    white-space: normal;
    word-break: break-word;
    top: 100%;
    left: 0;
    margin-top: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .copyable-text:hover .copy-tooltip,
  .position-relative:hover .copy-tooltip {
    display: block;
  }
  .copied-feedback {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 1100;
  }

  /* Table row hover effect */
  .table tbody tr:hover {
    background-color: rgba(0,0,0,0.075);
  }

  /* Print styles */
  @media print {

    .btn,
    .navbar,
    .footer {
      display: none !important;
    }

    .main-container {
      box-shadow: none !important;
      background: white !important;
    }

    .stats-card {
      background: #f8f9fa !important;
      color: #333 !important;
      border: 1px solid #dee2e6 !important;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Guardar temp_id para usar el int√©rprete y otras llamadas
  sessionStorage.setItem('json_temp_id', '{{ results.temp_id }}');

  (function () {
    const tempId = '{{ results.temp_id }}';
    const dslInput = document.getElementById('dslInput');
    const runBtn = document.getElementById('runQueryBtn');
    const exportXlsxBtn = document.getElementById('exportXlsxBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const presets = document.querySelectorAll('.preset');
    const tableWrap = document.getElementById('queryTableWrap');
    const table = document.getElementById('queryTable');
    const metaDiv = document.getElementById('queryMeta');
    const catalogBtn = document.getElementById('catalogBtn');
    const catalogOut = document.getElementById('catalogOut');

    presets.forEach(b => b.addEventListener('click', () => { dslInput.value = b.dataset.dsl || ''; }));

    // Pagination state
    let currentPage = 1;
    const rowsPerPage = 15;
    let allRows = [];

    function renderPagination(totalRows) {
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      if (totalPages <= 1) return '';

      let html = '<nav class="mt-3"><ul class="pagination justify-content-center">';
      
      // Previous button
      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
      </li>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
          <a class="page-link" href="#" data-page="${i}">${i}</a>
        </li>`;
      }

      // Next button
      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
      </li></ul></nav>`;

      return html;
    }

    let dataTable = null;

    function renderRows(rows) {
      if (!rows || rows.length === 0) { 
        tableWrap.style.display = 'none'; 
        table.innerHTML = ''; 
        return; 
      }
      
      // Get all columns first
      const allCols = [...new Set(rows.flatMap(r => Object.keys(r)))];
      
      // Define columns to exclude from grid display (but keep in exports)
      const excludedCols = [
        'isfire_root', 'event_name_root', 'isfire_bool',
        'fbc', 'fbp', 'ip_address', 'landing_url', 'user_agent',
        'utm_campaign', 'utm_content', 'utm_medium', 'utm_source'
      ];
      
      // Filter out excluded columns
      const cols = allCols.filter(col => !excludedCols.includes(col));
      
      // Create column definitions for DataTables
      // Helper function to truncate text
      function truncateText(text, maxLength = 100) {
        if (text && text.length > maxLength) {
          return text.substring(0, maxLength) + '...';
        }
        return text;
      }

      const columns = cols.map(col => ({
        data: col,
        title: col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        className: col === 'date' ? 'text-nowrap' : 'text-break position-relative',
        render: function(data, type, row) {
          if (type === 'display') {
            if (data == null) return '';
            
            // Format date column
            if (col === 'date' && data) {
              try {
                const date = new Date(data);
                return new Intl.DateTimeFormat('es-MX', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                }).format(date);
              } catch (e) {
                return data;
              }
            }

            // Format URLs as links
            if ((col === 'event_url' || col === 'zap_url') && data) {
              const url = new URL(data);
              const truncatedUrl = truncateText(url.pathname, 30);
              return `<div class="position-relative">
                <a href="${data}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                  <i class="fas fa-external-link-alt me-1"></i>${url.hostname}${truncatedUrl}
                </a>
                <div class="copy-tooltip" role="tooltip">${data}</div>
              </div>`;
            }
            
            // Email as link
            if (col === 'email' && data) {
              return `<a href="mailto:${data}" class="text-truncate d-inline-block">
                <i class="fas fa-envelope me-1"></i>${data}
              </a>`;
            }

            // Default truncation for other columns
            const fullText = String(data);
            if (fullText.length > 100) {
              return `<div class="position-relative copyable-text" data-full-text="${fullText}">
                <span>${truncateText(fullText)}</span>
                <div class="copy-tooltip" role="tooltip">${fullText}</div>
              </div>`;
            }
          }
          return data;
        }
      }));

      // Destroy existing DataTable if it exists
      if (dataTable) {
        dataTable.destroy();
        table.innerHTML = '';
      }
      
      // Create the table structure
      table.innerHTML = '<thead><tr>' + cols.map(c => `<th>${c.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('') + '</tr></thead>';
      tableWrap.style.display = '';
      
      // Add click-to-copy functionality
      $(table).on('click', '.copyable-text', function() {
        const text = $(this).data('full-text');
        navigator.clipboard.writeText(text).then(() => {
          // Show feedback
          const feedback = $('<div class="copied-feedback">Texto copiado al portapapeles</div>');
          $('body').append(feedback);
          setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 2000);
        });
      });

      // Initialize DataTable with enhanced features
      dataTable = $(table).DataTable({
        data: rows,
        columns: columns,
        pageLength: 15,
        orderCellsTop: true,
        fixedHeader: true,
        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"p>>',
        buttons: [
          {
            extend: 'collection',
            text: '<i class="fas fa-download me-1"></i>Export',
            buttons: [
              {
                extend: 'copy',
                text: '<i class="fas fa-copy me-1"></i>Copy',
                className: 'btn btn-sm'
              },
              {
                extend: 'excel',
                text: '<i class="fas fa-file-excel me-1"></i>Excel',
                className: 'btn btn-sm'
              },
              {
                extend: 'csv',
                text: '<i class="fas fa-file-csv me-1"></i>CSV',
                className: 'btn btn-sm'
              },
              {
                extend: 'print',
                text: '<i class="fas fa-print me-1"></i>Print',
                className: 'btn btn-sm'
              }
            ],
            className: 'btn btn-secondary'
          }
        ],
        order: [[cols.indexOf('date'), 'desc']], // Sort by date desc by default
        language: {
          search: "üîç Buscar:",
          lengthMenu: "Mostrar _MENU_ registros",
          zeroRecords: "No se encontraron registros",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 a 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros totales)",
          paginate: {
            first: "Primero",
            last: "√öltimo",
            next: "Siguiente",
            previous: "Anterior"
          }
        },
        initComplete: function() {
          // Add a row for column-specific filtering
          this.api().columns().every(function() {
            let column = this;
            let title = $(column.header()).text();
            
            // Create input element for filtering
            const input = $('<input type="text" class="form-control form-control-sm" placeholder="Filtrar '+title+'" />')
              .appendTo($(column.header()))
              .on('keyup change', function() {
                if (column.search() !== this.value) {
                  column.search(this.value).draw();
                }
              });
          });
        }
      });

      // Add custom complete export button
      const completeExportBtn = $('<button class="btn btn-success btn-sm ms-2"><i class="fas fa-file-excel me-1"></i>Export results (Excel)</button>');
      $(tableWrap).find('.dt-buttons').append(completeExportBtn);
      
      completeExportBtn.on('click', function() {
        // Export all data including hidden columns
        const allData = rows.map(row => {
          const exportRow = {};
          allCols.forEach(col => {
            const displayName = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            exportRow[displayName] = row[col] || '';
          });
          return exportRow;
        });
        
        // Create Excel file
        const ws = XLSX.utils.json_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Complete Data');
        
        // Auto-size columns
        const colWidths = [];
        Object.keys(allData[0] || {}).forEach((key, i) => {
          const maxLength = Math.max(
            key.length,
            ...allData.map(row => String(row[key] || '').length)
          );
          colWidths.push({ wch: Math.min(maxLength + 2, 50) });
        });
        ws['!cols'] = colWidths;
        
        // Download file
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        XLSX.writeFile(wb, `complete_data_${timestamp}.xlsx`);
        
        // Show feedback
        const feedback = $('<div class="copied-feedback">Excel completo exportado exitosamente</div>');
        $('body').append(feedback);
        setTimeout(() => feedback.fadeOut('fast', function() { $(this).remove(); }), 3000);
      });
      
      // Function to format cell content
      function formatCell(col, value) {
        if (value == null) return '';
        
        // Format date column
        if (col === 'date' && value) {
          try {
            const date = new Date(value);
            return new Intl.DateTimeFormat('es-MX', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            }).format(date);
          } catch (e) {
            return value;
          }
        }
        
        return value;
      }
      
      const thead = '<thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead>';
      const tbody = '<tbody>' + 
        rows.map(r => '<tr>' + 
          cols.map(c => `<td class="text-break">${formatCell(c, r[c])}</td>`).join('') + 
        '</tr>').join('') + 
      '</tbody>';
      
      table.innerHTML = thead + tbody; 
      tableWrap.style.display = '';
    }

    async function runQuery(exportFmt) {
      const dsl = (dslInput.value || '').trim();
      if (!dsl) { alert('Write a DSL query'); return; }
      metaDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Processing...</div>`;

      if (!exportFmt) {
        const res = await fetch('/api/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId, dsl }) });
        const data = await res.json();
        if (!res.ok || data.error) { metaDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown'}</div>`; renderRows([]); return; }
        const result = data.result || {};
        renderRows(result.rows || []);
        metaDiv.innerHTML = `
        <div class="alert alert-success">
          <div><strong>Filas:</strong> ${(result.rows || []).length}</div>
          ${result.meta?.group_by ? `<div><strong>Group by:</strong> ${result.meta.group_by.join(', ')}</div>` : ''}
          ${result.meta?.count ? `<div><strong>Count:</strong> Yes</div>` : ''}
        </div>`;
      } else {
        const res = await fetch('/api/export', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId, dsl, format: exportFmt }) });
        if (!res.ok) { const data = await res.json().catch(() => ({})); metaDiv.innerHTML = `<div class="alert alert-danger">Error exporting: ${data.error || res.statusText}</div>`; return; }
        const blob = await res.blob(); const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = exportFmt === 'csv' ? 'query.csv' : 'query.xlsx';
        document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
        metaDiv.innerHTML = `<div class="alert alert-success">File exported.</div>`;
      }
    }

    runBtn.addEventListener('click', () => runQuery(null));
    exportXlsxBtn.addEventListener('click', () => runQuery('xlsx'));
    exportCsvBtn.addEventListener('click', () => runQuery('csv'));

    catalogBtn.addEventListener('click', async () => {
      catalogOut.style.display = 'block';
      catalogOut.textContent = 'Cargando cat√°logo...';
      const res = await fetch('/api/catalog', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temp_id: tempId }) });
      const data = await res.json();
      catalogOut.textContent = res.ok ? JSON.stringify(data.catalog, null, 2) : (data.error || 'Error');
    });
  })();
</script>
{% endblock %}