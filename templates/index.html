{% extends "base.html" %}
{% block title %}Upload & Analyze - JSON Event Analyzer{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="text-center mb-4">
      <h1 class="display-4 fw-bold text-primary mb-3">
        <i class="fas fa-chart-line me-3"></i>JSON Event Analyzer
      </h1>
      <p class="lead text-muted">Upload your JSON and run basic or advanced analysis.</p>
    </div>

    <div class="card">
      <div class="card-body p-4">
        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
          <!-- File Upload -->
          <div class="mb-4">
            <label class="form-label fw-bold"><i class="fas fa-file-upload me-2"></i>Upload JSON File</label>
            <div class="file-upload-area" id="fileUploadArea">
              <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
              <h5>Drag & Drop your JSON file here</h5>
              <p class="text-muted">or click to browse</p>
              <input type="file" class="form-control d-none" id="fileInput" name="file" accept=".json" required>
              <button type="button" class="btn btn-outline-primary" id="chooseFileBtn">
                <i class="fas fa-folder-open me-2"></i>Choose File
              </button>
            </div>
            <div id="fileInfo" class="mt-3 d-none">
              <div class="alert alert-info">
                <i class="fas fa-file-code me-2"></i>
                <span id="fileName"></span>
                <span id="fileSize" class="text-muted"></span>
              </div>
            </div>
          </div>

          <!-- Basic Analysis Params (compat) -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="filterParam" class="form-label fw-bold"><i class="fas fa-filter me-2"></i>Filter Parameter</label>
              <input type="text" class="form-control" id="filterParam" name="filter_param" placeholder="e.g., fbc" required>
              <div class="form-text">The parameter to filter by (e.g., fbc)</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="rootId" class="form-label fw-bold"><i class="fas fa-hashtag me-2"></i>Root ID</label>
              <input type="text" class="form-control" id="rootId" name="root_id" placeholder="e.g., 305546688" required>
              <div class="form-text">The root ID to match against</div>
            </div>
          </div>

          <div class="mb-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="showIds" name="show_ids">
              <label class="form-check-label" for="showIds">
                <i class="fas fa-list me-2"></i>Show event IDs in results
              </label>
            </div>
          </div>

          <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
              <i class="fas fa-play me-2"></i>Analyze (Basic)
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- How it works -->
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>How it works</h5>
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width:60px;height:60px;">
              <i class="fas fa-upload fa-2x text-primary"></i>
            </div>
            <h6 class="mt-2">1. Upload</h6>
            <p class="text-muted small">Upload your Zapier JSON history</p>
          </div>
          <div class="col-md-4 text-center mb-3">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width:60px;height:60px;">
              <i class="fas fa-terminal fa-2x text-primary"></i>
            </div>
            <h6 class="mt-2">2. Ask</h6>
            <p class="text-muted small">Use the Interpreter (DSL) on results</p>
          </div>
          <div class="col-md-4 text-center mb-3">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width:60px;height:60px;">
              <i class="fas fa-file-export fa-2x text-primary"></i>
            </div>
            <h6 class="mt-2">3. Export</h6>
            <p class="text-muted small">Download CSV/XLSX of your queries</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('fileInput');
  const fileUploadArea = document.getElementById('fileUploadArea');
  const chooseFileBtn = document.getElementById('chooseFileBtn');
  const fileInfo = document.getElementById('fileInfo');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('uploadForm');

  function setSubmitEnabled(flag) { submitBtn.disabled = !flag; }

  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      fileName.textContent = file.name;
      fileSize.textContent = `(${(file.size/1024/1024).toFixed(2)} MB)`;
      fileInfo.classList.remove('d-none');
      setSubmitEnabled(true);
    } else {
      fileInfo.classList.add('d-none');
      setSubmitEnabled(false);
    }
  });

  fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
  fileUploadArea.addEventListener('dragleave', e => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); });
  fileUploadArea.addEventListener('drop', function(e) {
    e.preventDefault(); fileUploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) { fileInput.files = files; fileInput.dispatchEvent(new Event('change')); }
  });

  fileUploadArea.addEventListener('click', function(e) {
    if (e.target.closest('#chooseFileBtn')) return;
    fileInput.click();
  });
  chooseFileBtn.addEventListener('click', function(e) {
    e.stopPropagation(); fileInput.click();
  });

  form.addEventListener('submit', function(e) {
    const filterParam = document.getElementById('filterParam').value.trim();
    const rootId = document.getElementById('rootId').value.trim();
    if (!filterParam || !rootId) { e.preventDefault(); alert('Please fill in all required fields.'); }
  });
});
</script>
{% endblock %}
